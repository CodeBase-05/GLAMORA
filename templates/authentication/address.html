{% extends 'base.html' %}
{% load static %}

{% block title %}Address - Glamora{% endblock %}

{% block content %}
<div class="homepage-wrapper">
    <header class="main-header">
        <div class="header-left">
            <button class="hamburger-menu" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="{% url 'home' %}" class="logo-section-header" style="text-decoration: none; color: inherit; cursor: pointer;">
                <img src="{% static 'images/favicon.jpg' %}" alt="Glamora Logo" class="logo-favicon">
                <span class="logo-text-header">GLAMORA</span>
            </a>
        </div>
        <div class="header-right">
            <nav class="main-nav" id="mainNav">
                <a href="{% url 'home' %}" class="nav-link">Home</a>
                <a href="{% url 'services' %}" class="nav-link">Services</a>
                <a href="{% url 'my_bookings' %}" class="nav-link">My Bookings</a>
                <a href="{% url 'my_receipts' %}" class="nav-link">My Receipts</a>
                <a href="{% url 'profile' %}" class="nav-link">Profile</a>
            </nav>
        </div>
    </header>

    <div class="main-layout">
        <main class="main-content" style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
            <h1 style="font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 30px; text-align: center;">Delivery Address</h1>
            
            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h2 style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 15px;">Booking Summary</h2>
                <p style="margin: 8px 0;"><strong>Service:</strong> {{ pending_booking.service_name }}</p>
                <p style="margin: 8px 0;"><strong>Price:</strong> {{ pending_booking.service_price }}</p>
                <p style="margin: 8px 0;"><strong>Date:</strong> {{ pending_booking.formatted_date }}</p>
                <p style="margin: 8px 0;"><strong>Time:</strong> {{ pending_booking.booking_time }}</p>
                <p style="margin: 8px 0;"><strong>Payment:</strong> {{ payment_data.method|title }}{% if payment_data.card_number and payment_data.card_number|length > 0 %} (****{{ payment_data.card_number }}){% endif %}</p>
            </div>

            <form method="POST" style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                {% csrf_token %}
                
                <h2 style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 25px;">Enter Your Address</h2>
                
                {% if saved_addresses %}
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: bold; color: #000; margin-bottom: 15px; font-size: 1rem;">Select Address</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {% for addr in saved_addresses %}
                        <label style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; position: relative;" onmouseover="this.style.borderColor='#603D44'" onmouseout="this.style.borderColor='#e0e0e0'">
                            <input type="radio" name="use_saved_address" value="yes" data-address-id="{{ addr.id }}" data-saved-address="{{ addr.full_address|escapejs }}" style="margin-right: 12px;" onchange="handleAddressSelection(this)">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">Saved Address {{ forloop.counter }}</div>
                                <div style="font-size: 0.9rem; color: #666;">{{ addr.full_address }}</div>
                            </div>
                            <button type="button" class="delete-address-btn" data-address-id="{{ addr.id }}" style="background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; color: #e74c3c; transition: color 0.3s;" onmouseover="this.style.color='#c0392b'" onmouseout="this.style.color='#e74c3c'" title="Delete Address">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </label>
                        {% endfor %}
                        <label style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#603D44'" onmouseout="this.style.borderColor='#e0e0e0'">
                            <input type="radio" name="use_saved_address" value="no" checked style="margin-right: 12px;" onchange="handleAddressSelection(this)">
                            <div style="font-weight: bold; color: #333;">Enter New Address</div>
                        </label>
                    </div>
                    <input type="hidden" name="selected_address_id" id="selected_address_id" value="">
                    <input type="hidden" id="saved_addresses_count" value="{{ saved_addresses|length|default:0 }}">
                </div>
                {% else %}
                <input type="hidden" id="saved_addresses_count" value="0">
                {% endif %}
                
                <div id="addressFields">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">Address Line 1 <span style="color: red;">*</span></label>
                    <input type="text" name="address_line1" id="address_line1" placeholder="Street address, P.O. box" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">Address Line 2</label>
                    <input type="text" name="address_line2" id="address_line2" placeholder="Apartment, suite, unit, building, floor, etc." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">City <span style="color: red;">*</span></label>
                        <input type="text" name="city" id="city" placeholder="City" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">State <span style="color: red;">*</span></label>
                        <input type="text" name="state" id="state" placeholder="State" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">Zip Code <span style="color: red;">*</span></label>
                        <input type="text" name="zip_code" id="zip_code" placeholder="12345" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #000; margin-bottom: 8px; font-size: 1rem;">Country</label>
                        <input type="text" name="country" id="country" placeholder="Country" value="USA" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                </div>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background-color: #f9f9f9; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="save_address" id="save_address" style="margin-right: 10px;" onchange="checkAddressLimit()" {% if saved_addresses|length >= 3 %}disabled{% endif %}>
                        <span style="font-weight: 500; color: #333;">Save this address for future use</span>
                    </label>
                    {% if saved_addresses|length >= 3 %}
                    <div id="addressLimitWarning" style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; color: #856404; font-size: 0.9rem; display: block;">
                        <strong>Note:</strong> You have reached the maximum of 3 saved addresses. Please delete an existing address to save a new one.
                    </div>
                    {% endif %}
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <a href="{% url 'payment' %}" style="flex: 1; padding: 14px; background-color: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; text-align: center; text-decoration: none;">
                        Back
                    </a>
                    <button type="submit" style="flex: 1; padding: 14px; background-color: #603D44; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        Confirm Booking
                    </button>
                </div>
            </form>
        </main>
    </div>
</div>

<script>
// Handle address selection
function handleAddressSelection(radio) {
    const addressLine1 = document.getElementById('address_line1');
    const addressLine2 = document.getElementById('address_line2');
    const city = document.getElementById('city');
    const state = document.getElementById('state');
    const zipCode = document.getElementById('zip_code');
    const country = document.getElementById('country');
    const selectedAddressId = document.getElementById('selected_address_id');
    
    if (!addressLine1 || !city || !state || !zipCode || !country) return;
    
    if (radio.value === 'yes') {
        // Using saved address
        const savedAddress = radio.getAttribute('data-saved-address');
        const addressId = radio.getAttribute('data-address-id');
        
        if (selectedAddressId) {
            selectedAddressId.value = addressId || '';
        }
        
        if (savedAddress) {
            // Parse saved address (simple parsing - adjust based on your address format)
            const parts = savedAddress.split(',');
            if (parts.length >= 3) {
                addressLine1.value = parts[0].trim();
                if (parts.length > 3 && addressLine2) {
                    addressLine2.value = parts[1].trim();
                    city.value = parts[parts.length - 2].trim();
                    const stateZip = parts[parts.length - 1].trim().split(' ');
                    if (stateZip.length >= 2) {
                        state.value = stateZip[0];
                        zipCode.value = stateZip[1];
                    }
                } else {
                    city.value = parts[1].trim();
                    const stateZip = parts[2].trim().split(' ');
                    if (stateZip.length >= 2) {
                        state.value = stateZip[0];
                        zipCode.value = stateZip[1];
                    }
                }
            } else {
                // If parsing fails, just fill address line 1
                addressLine1.value = savedAddress;
            }
        }
        
        // Disable address fields and hide save checkbox
        [addressLine1, addressLine2, city, state, zipCode, country].forEach(field => {
            if (field) {
                field.disabled = true;
                field.required = false;
            }
        });
        const saveAddressCheckbox = document.getElementById('save_address');
        if (saveAddressCheckbox) {
            saveAddressCheckbox.disabled = true;
            saveAddressCheckbox.checked = false;
        }
    } else {
        // Entering new address - clear and enable fields
        if (selectedAddressId) {
            selectedAddressId.value = '';
        }
        addressLine1.value = '';
        if (addressLine2) addressLine2.value = '';
        city.value = '';
        state.value = '';
        zipCode.value = '';
        country.value = 'USA';
        
        // Enable address fields and show save checkbox
        [addressLine1, addressLine2, city, state, zipCode, country].forEach(field => {
            if (field) {
                field.disabled = false;
                if (field.id !== 'address_line2' && field.id !== 'country') {
                    field.required = true;
                }
            }
        });
        const saveAddressCheckbox = document.getElementById('save_address');
        if (saveAddressCheckbox) {
            saveAddressCheckbox.disabled = false;
        }
        checkAddressLimit();
    }
}

// Check address limit
function checkAddressLimit() {
    const saveAddressCheckbox = document.getElementById('save_address');
    const addressLimitWarning = document.getElementById('addressLimitWarning');
    const savedAddressesCountElement = document.getElementById('saved_addresses_count');
    const savedAddressesCount = savedAddressesCountElement ? parseInt(savedAddressesCountElement.value) : 0;
    
    if (saveAddressCheckbox && saveAddressCheckbox.checked && savedAddressesCount >= 3) {
        if (addressLimitWarning) {
            addressLimitWarning.style.display = 'block';
        }
        saveAddressCheckbox.checked = false;
        alert('You can only save up to 3 addresses. Please delete an existing address to save a new one.');
    } else if (addressLimitWarning) {
        addressLimitWarning.style.display = savedAddressesCount >= 3 ? 'block' : 'none';
    }
}

// Delete address function
function deleteAddress(addressId, event) {
    if (event) {
        event.stopPropagation(); // Prevent radio button selection
    }
    
    if (!confirm('Are you sure you want to delete this address?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('address_id', addressId);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch('{% url "delete_address" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated addresses
            window.location.reload();
        } else {
            alert(data.error || 'Failed to delete address');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the address');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const checkedRadio = document.querySelector('input[name="use_saved_address"]:checked');
    if (checkedRadio) {
        handleAddressSelection(checkedRadio);
    }
    
    // Attach delete button event listeners
    const deleteButtons = document.querySelectorAll('.delete-address-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            const addressId = this.getAttribute('data-address-id');
            if (addressId) {
                deleteAddress(parseInt(addressId), event);
            }
        });
    });
});

function toggleSidebar() {
    // Sidebar functionality if needed
}
</script>
{% endblock %}
