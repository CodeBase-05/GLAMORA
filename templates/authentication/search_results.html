{% extends 'base.html' %}
{% load static %}

{% block title %}Search Results - Glamora{% endblock %}

{% block content %}
<div class="homepage-wrapper">
    <header class="main-header">
        <div class="header-left">
            <button class="hamburger-menu" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="{% url 'home' %}" class="logo-section-header" style="text-decoration: none; color: inherit; cursor: pointer;">
                <img src="{% static 'images/favicon.jpg' %}" alt="Glamora Logo" class="logo-favicon">
                <span class="logo-text-header">GLAMORA</span>
            </a>
        </div>
        <div class="header-right">
            <button class="search-icon" id="searchIcon" onclick="toggleSearch()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </button>
            <div class="search-bar" id="searchBar">
                <div class="search-input-wrapper">
                    <svg class="search-icon-inside" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search for services..." class="search-input" value="{{ query }}" oninput="showSuggestions()" onkeypress="handleSearchKeyPress(event)">
                    <button class="search-submit-btn" onclick="performSearch()" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <nav class="main-nav" id="mainNav">
                <a href="{% url 'home' %}" class="nav-link">Home</a>
                <a href="{% url 'services' %}" class="nav-link">Services</a>
                <a href="{% url 'my_bookings' %}" class="nav-link">My Bookings</a>
                <a href="{% url 'my_receipts' %}" class="nav-link">My Receipts</a>
                <a href="{% url 'profile' %}" class="nav-link">Profile</a>
            </nav>
        </div>
    </header>

    <div class="main-layout">
        <main class="main-content">
            <div class="search-results-header">
                <h1>Search Results</h1>
                {% if query %}
                    <p class="search-query">Results for "<strong>{{ query }}</strong>"</p>
                    <p class="results-count">{{ results_count }} service{{ results_count|pluralize }} found</p>
                {% else %}
                    <p class="search-query">Showing all services</p>
                    <p class="results-count">{{ results_count }} services available</p>
                {% endif %}
            </div>

            <div class="services-grid">
                {% for service in services %}
                <div class="service-card">
                    {% if service.discount %}
                        <div class="discount-badge">{{ service.discount }}</div>
                    {% endif %}
                    <div class="service-image">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#603D44" stroke-width="1.5">
                            <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <path d="M6 18v-7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v7"></path>
                        </svg>
                    </div>
                    <div class="service-details">
                        <h3 class="service-name">{{ service.name }}</h3>
                        <p class="service-description">{{ service.description }}</p>
                        <div class="service-price">
                            {% if service.original_price %}
                                <span style="text-decoration: line-through; color: #999; font-size: 0.9rem; margin-right: 8px;">{{ service.original_price }}</span>
                            {% endif %}
                            <span>{{ service.price }}</span>
                        </div>
                        <button class="book-btn" onclick="bookService('{{ service.name }}', '{{ service.price }}', '{{ service.description }}')">Book Appointment</button>
                    </div>
                </div>
                {% empty %}
                <div class="no-results">
                    <p>No services found matching your search.</p>
                    <a href="{% url 'home' %}" class="back-home-btn">Back to Home</a>
                </div>
                {% endfor %}
            </div>
        </main>
    </div>
</div>

<script>
// Available services for suggestions (shared JSON from backend)
const services = JSON.parse('{{ search_suggestions_json|escapejs }}');

function toggleSearch() {
    const searchBar = document.getElementById('searchBar');
    const searchIcon = document.getElementById('searchIcon');
    
    searchBar.classList.toggle('active');
    
    if (searchBar.classList.contains('active')) {
        searchIcon.classList.add('hidden');
        document.getElementById('searchInput').focus();
    } else {
        searchIcon.classList.remove('hidden');
        document.getElementById('searchInput').value = '';
        hideSuggestions();
    }
}

function showSuggestions() {
    const searchInput = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('searchSuggestions');
    const query = searchInput.value.toLowerCase().trim();
    
    if (query.length === 0) {
        hideSuggestions();
        return;
    }
    
    const filtered = services.filter(service => 
        service.name.toLowerCase().includes(query)
    );
    
    if (filtered.length === 0) {
        suggestionsDiv.innerHTML = '<div class="suggestion-item no-results">No services found</div>';
        suggestionsDiv.style.display = 'block';
        return;
    }
    
    suggestionsDiv.innerHTML = filtered.slice(0, 5).map(service => {
        const escapedName = service.name.replace(/'/g, "\\'");
        return `<div class="suggestion-item" onclick="selectSuggestion('${escapedName}')">
            <span class="suggestion-name">${service.name}</span>
            <span class="suggestion-price">${service.price}</span>
        </div>`;
    }).join('');
    
    suggestionsDiv.style.display = 'block';
}

function hideSuggestions() {
    document.getElementById('searchSuggestions').style.display = 'none';
}

function selectSuggestion(serviceName) {
    document.getElementById('searchInput').value = serviceName;
    hideSuggestions();
    performSearch();
}

function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
}

function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput.value.trim();
    
    if (query.length > 0) {
        window.location.href = `/search/?q=${encodeURIComponent(query)}`;
    }
}

function bookService(serviceName, servicePrice, serviceDescription) {
    const url = `{% url 'booking' %}?service=${encodeURIComponent(serviceName)}&price=${encodeURIComponent(servicePrice)}&description=${encodeURIComponent(serviceDescription)}`;
    window.location.href = url;
}

document.addEventListener('click', function(event) {
    const searchBar = document.getElementById('searchBar');
    const searchIcon = document.getElementById('searchIcon');
    
    if (searchBar.classList.contains('active')) {
        if (!searchBar.contains(event.target) && !searchIcon.contains(event.target)) {
            searchBar.classList.remove('active');
            searchIcon.classList.remove('hidden');
            document.getElementById('searchInput').value = '';
            hideSuggestions();
        }
    }
});

function toggleSidebar() {
    // Sidebar functionality if needed
}

// Redirect to home page on reload
document.addEventListener('DOMContentLoaded', function() {
    // Check if page is being reloaded
    if (performance.navigation && performance.navigation.type === performance.navigation.TYPE_RELOAD) {
        // Redirect to home page on reload
        window.location.href = "{% url 'home' %}";
        return;
    }
    
    // Also check using PerformanceNavigationTiming API (modern browsers)
    const navigation = performance.getEntriesByType('navigation')[0];
    if (navigation && navigation.type === 'reload') {
        // Redirect to home page on reload
        window.location.href = "{% url 'home' %}";
        return;
    }
});
</script>
{% endblock %}

