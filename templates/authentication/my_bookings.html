{% extends 'base.html' %}
{% load static %}

{% block title %}My Bookings - Glamora{% endblock %}

{% block content %}
<div class="homepage-wrapper">
    <header class="main-header">
        <div class="header-left">
            <button class="hamburger-menu" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="{% url 'home' %}" class="logo-section-header" style="text-decoration: none; color: inherit; cursor: pointer;">
                <img src="{% static 'images/favicon.jpg' %}" alt="Glamora Logo" class="logo-favicon">
                <span class="logo-text-header">GLAMORA</span>
            </a>
        </div>
        <div class="header-right">
            <nav class="main-nav" id="mainNav">
                <a href="{% url 'home' %}" class="nav-link">Home</a>
                <a href="{% url 'services' %}" class="nav-link">Services</a>
                <a href="{% url 'my_bookings' %}" class="nav-link active">My Bookings</a>
                <a href="{% url 'my_receipts' %}" class="nav-link">My Receipts</a>
                <a href="{% url 'profile' %}" class="nav-link">Profile</a>
            </nav>
        </div>
    </header>

    <div class="main-layout">
        <main class="main-content">
            <div class="services-page-header">
                <h1>My Bookings</h1>
                <p>View and manage your appointments</p>
            </div>

            {% if bookings %}
                <div class="services-grid">
                    {% for booking in bookings %}
                    <div class="service-card" id="booking-{{ booking.id }}" style="position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 10;">
                            <button type="button" class="edit-booking-btn" data-booking-id="{{ booking.id }}" onclick="window.location.href='{% url 'edit_booking' %}?id={{ booking.id }}'" style="background: none; border: none; cursor: pointer; padding: 5px; color: #603D44; transition: transform 0.2s;" title="Edit Booking">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="delete-booking-btn" data-booking-id="{{ booking.id }}" style="background: none; border: none; cursor: pointer; padding: 5px; color: #dc3545; transition: transform 0.2s;" title="Delete Booking">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="service-image">
                            {% if booking.service_image %}
                                <img src="{{ booking.service_image }}" alt="{{ booking.service_name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            {% else %}
                                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#603D44" stroke-width="1.5">
                                    <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                    <path d="M6 18v-7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v7"></path>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="service-details">
                            <h3 class="service-name">{{ booking.service_name }}</h3>
                            <p class="service-description">{{ booking.service_description }}</p>
                            <div class="service-price">{{ booking.service_price }}</div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Date:</strong> {{ booking.booking_date|date:"F d, Y" }}</p>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Time:</strong> {{ booking.booking_time }}</p>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Status:</strong> <span style="color: #28a745; font-weight: 600;">{{ booking.status|title }}</span></p>
                                {% if booking.employee_name %}
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                                    <p style="margin: 5px 0; color: #603D44; font-size: 0.9rem; font-weight: 600;">Assigned Employee:</p>
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Name:</strong> {{ booking.employee_name }}</p>
                                    {% if booking.employee_phone and booking.employee_phone != 'N/A' %}
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Phone:</strong> {{ booking.employee_phone }}</p>
                                    {% endif %}
                                    {% if booking.employee_rating %}
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><strong>Rating:</strong> <span style="color: #ffc107;">{{ booking.employee_rating|floatformat:1 }}★</span></p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 60px 20px;">
                    <p style="font-size: 1.2rem; color: #666; margin-bottom: 20px;">No bookings found</p>
                    <a href="{% url 'services' %}" class="book-btn" style="display: inline-block; padding: 12px 30px; background-color: #603D44; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">Book a Service</a>
                </div>
            {% endif %}
        </main>
    </div>
</div>

<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 35px; border-radius: 15px; max-width: 420px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); text-align: center;">
        <h2 id="deleteModalTitle" style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 15px;">Delete Booking</h2>
        <div id="deleteModalContent">
            <p style="color: #555; margin-bottom: 25px;">Are you sure you want to delete this booking?</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="cancelDeleteBtn" style="padding: 10px 25px; background-color: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Cancel</button>
                <button id="confirmDeleteBtn" style="padding: 10px 25px; background-color: #dc3545; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
const editBookingUrl = '{% url "edit_booking" %}';

function editBooking(bookingId) {
    if (bookingId) {
        window.location.href = editBookingUrl + '?id=' + bookingId;
    }
}

// Redirect to home on page reload
(function() {
    const navigation = performance.getEntriesByType('navigation')[0];
    if (navigation && navigation.type === 'reload') {
        window.location.href = '{% url "home" %}';
    } else if (performance.navigation && performance.navigation.type === performance.navigation.TYPE_RELOAD) {
        window.location.href = '{% url "home" %}';
    }
})();

function toggleSidebar() {
    // Sidebar functionality if needed
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let pendingDeleteId = null;

function openDeleteModal(bookingId) {
    pendingDeleteId = bookingId;
    // Reset modal content
    document.getElementById('deleteModalTitle').textContent = 'Delete Booking';
    document.getElementById('deleteModalContent').innerHTML = `
        <p style="color: #555; margin-bottom: 25px;">Are you sure you want to delete this booking?</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button id="cancelDeleteBtn" onclick="closeDeleteModal()" style="padding: 10px 25px; background-color: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Cancel</button>
            <button id="confirmDeleteBtn" onclick="deleteBooking()" style="padding: 10px 25px; background-color: #dc3545; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Delete</button>
        </div>
    `;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    pendingDeleteId = null;
}

function deleteBooking() {
    if (!pendingDeleteId) return;

    const formData = new FormData();
    formData.append('booking_id', pendingDeleteId);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    // Hide buttons while processing
    document.getElementById('cancelDeleteBtn').style.display = 'none';
    document.getElementById('confirmDeleteBtn').style.display = 'none';
    
    fetch('{% url "delete_booking" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            document.getElementById('deleteModalTitle').textContent = 'Booking Deleted';
            document.getElementById('deleteModalContent').innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; border: 2px solid #c3e6cb; margin-bottom: 20px;">
                    <p style="margin: 10px 0; color: #155724; font-size: 1.1rem; font-weight: 600;">✓ Booking deleted successfully!</p>
                </div>
            `;
            
            // Remove the booking card from the page
            const bookingCard = document.getElementById('booking-' + pendingDeleteId);
            if (bookingCard) {
                bookingCard.style.transition = 'opacity 0.3s';
                bookingCard.style.opacity = '0';
                setTimeout(() => {
                    bookingCard.remove();
                    const remainingBookings = document.querySelectorAll('.service-card');
                    if (remainingBookings.length === 0) {
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            closeDeleteModal();
                        }, 1500);
                    }
                }, 300);
            } else {
                setTimeout(() => {
                    closeDeleteModal();
                }, 1500);
            }
        } else {
            // Show error message
            document.getElementById('deleteModalTitle').textContent = 'Error';
            document.getElementById('deleteModalContent').innerHTML = `
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; border: 2px solid #f8d7da; margin-bottom: 20px;">
                    <p style="margin: 10px 0; color: #721c24;"><strong>Error:</strong> ${data.error || 'Failed to delete booking'}</p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="closeDeleteModal()" style="padding: 10px 25px; background-color: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Close</button>
                </div>
            `;
        }
    })
    .catch(error => {
        // Show error message
        document.getElementById('deleteModalTitle').textContent = 'Error';
        document.getElementById('deleteModalContent').innerHTML = `
            <div style="background: #fff5f5; padding: 20px; border-radius: 10px; border: 2px solid #f8d7da; margin-bottom: 20px;">
                <p style="margin: 10px 0; color: #721c24;"><strong>Error:</strong> ${error.message}</p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="closeDeleteModal()" style="padding: 10px 25px; background-color: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        `;
    })
    .finally(() => {
        pendingDeleteId = null;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-booking-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.2)';
        });
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-booking-id');
            openDeleteModal(bookingId);
        });
    });

    const editButtons = document.querySelectorAll('.edit-booking-btn');
    editButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.2)';
        });
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });

    // Event listeners are now in the modal HTML (onclick handlers)
    document.getElementById('deleteModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeDeleteModal();
        }
    });
});
</script>
{% endblock %}

